#!/usr/bin/perl

use strict;
use warnings;

use Getopt::Long;
use Mail::Milter::Authentication;
use Mail::Milter::Authentication::Config qw{ get_config };

# CONFIG
my $CONFIG = get_config();
my $connection = $CONFIG->{'connection'};
my $pid_file = '/run/authentication_milter.pid';
my $daemon = 0;
my $help   = 0;

GetOptions (
    "daemon"    => \$daemon,
    "pidfile=s" => \$pid_file,
    "help"      => \$help
) or die "Error in command line arguments\n";

if ( $help ) {
    usage();
    exit 0;
}

Mail::Milter::Authentication::start({
    'connection' => $connection,
    'pid_file'   => $pid_file,
    'daemon'     => $daemon,
});

sub usage {
    print STDERR qq{Usage: $0 [-d|--daemon] [-p|--pidfile <file>] [-h|--help]

-h|--help
    Show this help.

-d|--daemon
    detatch from shell and run as a daemon

-p|--pidfile <file>
    Write the process PID to the given file.
    defaults to /run/authentication_milter.pid

Reads configuration from /etc/authentication_milter.json

};
}

