#!/usr/bin/perl

use strict;
use warnings;
use English;

use Mail::Milter::Authentication;
use Mail::Milter::Authentication::Config;

# CONFIG
my $CONFIG = Mail::Milter::Authentication::Config::get_config();
my $connection = $CONFIG->{'connection'};
my $pid_file = '/run/authentication_milter.pid';

# CONCURRENCY CHECKING
# Cannot use a simple lock due to the way PMilter works.
if ( -e $pid_file ) {
    open my $pidf, '<', $pid_file;
    my $pid = <$pidf>;
    close $pidf;
    my $proc = '/proc/' . $pid;
    if ( -e $proc ) {
        die "Process already running";
    }
}

# PID
{
    my $pid = $PID;
    open my $pidf, '>', $pid_file;
    print $pidf $pid;
    close $pidf;
}

Mail::Milter::Authentication::start({
    'connection' => $connection,
});

